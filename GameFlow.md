# 回声追踪（暗林围猎）游戏流程设计（增强版）

> **注意：** 本文档中的所有具体数值（如时长、半径、数量）均已参数化，请务必参考同目录下的 `game_config.json` 配置文件进行修改。文档中出现的数值仅为默认配置示例，旨在说明逻辑关系。

---

### 1. 初始化与匹配阶段：幽暗集结

这是房间实例从虚无中诞生的起点，服务器将编织一个充满未知与机遇的舞台。

* **服务端行为：**
  * **迷宫生成：** 在绝对的寂静中，服务端利用 **Prim 算法** 生成一个规模为 `map.width` x `map.height`（默认 32x32）的二维迷宫矩阵。算法如同无形的刻刀，在数据流中雕琢出蜿蜒的**通路**与坚实的**岩壁**，确保迷宫**连通且充满分支**。
  * **资源投放：** 在迷宫生成后，系统将随机撒下若干“**宝藏点**”（闪烁着微光的资源堆）和“**电机点**”（初始处于沉寂、不可交互的黑暗状态），作为后续冲突的诱因。
  * **玩家入场：** 服务器化身为沉默的接待者，等待最多 `server.max_players_per_room`（默认 6）名猎手通过 Python 客户端连接。每一声连接提示音响起，服务端便为其分配一个唯一的、不可伪造的 `SessionID`，作为其在此局中的数字身份。
  * **倾向选择：** 连接成功后，玩家需在客户端界面上进行关键的 **“战术倾向”** 选择（例如：**幽灵般的侦察型**、**磐石般的防御型**、**狡诈的陷阱型**）。服务端根据此选择，为玩家初始化一个容量为 `gameplay.inventory_size`（默认 6 格）的**初始背包**，并可能预置少量与倾向相关的**基础道具**（如侦察型的低配望远镜、防御型的小型护甲片）。
  * **出生点分配：** 为确保开局公平，服务端会在迷宫的安全区域（远离中心及资源密集区）为所有玩家**随机分配出生点**。算法会强制保证任意两名玩家初始位置的欧几里得距离大于 `spawn.min_distance_between_players`（默认 10.0）米，营造一种“各自为营”的紧张开局氛围。

* **阶段转换：** 当房间达到满员状态，或等待倒计时 `server.wait_for_players_timeout_sec` 结束且在场玩家数满足最小开局要求 `server.min_players_to_start`（默认 2）时，服务器将向所有客户端庄严地广播 `Game_Start` 指令。同时，**同步发送初始地图种子、所有玩家的出生坐标及初始状态快照**，确保所有人在同一幅画卷上开始冒险。

---

### 2. 第一阶段：暗影潜伏期

**持续时间：`phases.phase_1_search.duration_sec`（默认 120 秒）**
**氛围：** 绝对的黑暗与寂静，只有自己的呼吸声和脚步声在迷宫石壁间轻微回响。这是属于搜集者与潜伏者的黄金时间。

* **玩家核心行为：** 在浓得化不开的黑暗中**谨慎摸索**，凭借微弱的视野寻找散落的“**宝藏**”（直接兑换为赏金）和各类“**道具**”（改变战局的关键）。玩家可以执行**拾取**、**丢弃**、**使用道具**等基础交互。
* **核心逻辑详解：**
  * **战争迷雾机制：** 玩家的可视范围被严格限制在以自身为中心、半径为 `gameplay.base_view_radius`（默认 5.0）米的**圆形光域**内。光域之外，是吞噬一切的**浓密战争迷雾**，地图地形和他人踪迹完全隐匿。
  * **静默移动艺术：** 当玩家将移动速度控制在 `movement.silent_speed_threshold` 阈值以下时，其移动被视为“**静默移动**”，**不会产生任何可被他人侦测的声音波纹**。这是潜行与伏击的基础。
  * **动态负重系统：** 这是一个真实而残酷的设定。随着背包中道具增多，玩家的 `Weight`（负重值）线性上升。服务端根据负重百分比**实时动态修正**玩家的最大移动速度。当负重超过 `weight_threshold_noise_double`（默认 50%）时，玩家移动时产生的**声音传播半径翻倍**，更容易暴露行踪。当负重达到 `weight_threshold_speed_cap`（默认 80%）的临界点时，移动速度将降至预设的**最低值**，步履维艰。
  * **道具拾取规则：** 玩家靠近可拾取物体并触发交互指令后，若背包有空余格子，则物品自动存入。若背包已满，则拾取动作失败，并应有明确的UI提示。
  * **安全箱——最后的保障：** 每位玩家拥有 `gameplay.safe_slot_count`（默认 2）个标记为“**安全**”的背包格子。无论发生什么，存放在此格内的道具在玩家死亡时**绝对不会掉落**，是风险投资中的保底资产。

* **阶段战略目的：** 在相对安全的环境下**最大化积累个人资源**，为即将到来的正面冲突储备弹药、道具和资本。此时，理性的玩家大多倾向于**避战**，专注于地图探索与物资搜集。

---

### 3. 第二阶段：噪波冲突期

**持续时间：`phases.phase_2_conflict.duration_sec`（默认 180 秒）**
**氛围：** 黑暗被打破，紧张感陡增。电机启动的嗡鸣成为战场主旋律，道具的光效与攻击的音效在迷宫中此起彼伏。

* **阶段触发：** 第一阶段倒计时归零的瞬间。服务端激活地图上预设的 `phases.phase_2_conflict.motors_spawn_count`（默认 5）个**电机点**，使其从不可交互状态变为可破译目标。同时，向**全体玩家**广播所有电机的大致方位信息（例如，采用**区域象限编号法**：“电机A位于东北区”）。
* **核心逻辑详解：**
  * **破译与广播：** 玩家靠近电机并开始交互后，需持续引导 `motor_decipher_time_sec` 秒以完成破译。在此期间，电机会发出持续且强烈的“**工作噪音**”。以电机为中心、`hear_radius`（默认 12.0）米范围内的所有玩家，其用户界面（UI）上都会收到该电机的“**动态闪烁提示**”（通过AOI系统的L2级广播实现）。破译进度可以被其他玩家的**攻击行为**或**特定干扰道具**打断。
  * **道具介入与博弈：**
    *   **攻击即消耗：** 游戏中**不存在**无消耗的基础普通攻击。想要造成伤害，**必须**消耗背包内的攻击类道具（如“一次性电击器”、“投掷飞刀”）。
    *   **视野即射程：** 发动基础攻击的前提是**目标必须处于玩家的当前视野（View Radius）内**。
        *   玩家操作：在客户端选中视野内的某个目标 -> 按下道具快捷键 -> 服务端校验距离与视野 -> 扣除道具并结算伤害（默认 `combat.base_attack_damage`）。
    *   **高级侦察与超视距打击：**
        *   高级侦察类道具（如“全境扫描终端”）使用后，可**强制将一名随机或指定玩家的实时坐标向全图广播**，持续 `combat.advanced_recon_duration_sec` (默认 30) 秒。
        *   这不仅暴露了受害者位置，更配合某些**“追踪型”或“超视距”攻击道具**，变相无限扩大了攻击范围，让原本看不见的敌人变得可被锁定。

  * **死亡与遗产：** 玩家被击杀后，其背包内**除安全箱格子外**的所有道具，将作为一个“**掉落包**”在死亡坐标生成，可供其他玩家拾取。服务端需立即广播此掉落包的位置更新。被击杀玩家则进入**观战模式**或选择断开连接。
  * **破译完成：** 单个电机被成功破译后，将永久变为**不可用状态**（模型可变为破损或激活完成态），其完成数量会计入**全局破译进度**。

* **阶段战略目的：** 从“搜集”转向“**争夺**”与“**淘汰**”。玩家需要积极争夺电机破译权以获得战略优势，同时通过战斗**掠夺他人资源**，并尽可能消灭竞争对手，为最终的撤离减少阻碍。

---

### 4. 第三阶段：终局撤离期

**触发条件：** 场上累计有任意 `motors_required_to_open_exit`（默认 2）个电机被完全破译。
**氛围：** 绝望与希望交织。全图脉冲如同死神的倒计时，不断收缩的视野将幸存者逼向唯一的生路，而有限的撤离名额则引发了最后的残酷竞争。

* **撤离门核心机制：**
  * **出口激活：** 满足触发条件后，服务端从地图预设的多个撤离点中，**随机选定1个**作为本局游戏的**唯一有效撤离出口**，并将其**精确坐标**广播给所有幸存玩家。
  * **名额限制——残酷的生存游戏：** 该撤离点总共只允许 `phases.phase_3_escape.extraction_slots_total`（默认 2）名玩家成功撤离。这是引发最终对决的直接导火索。
  * **激活流程：** 玩家必须站在撤离点有效范围内，并持续进行交互达 `extraction_activate_time_sec`（默认 3 秒）才能**激活个人撤离**。在此期间玩家无法进行其他动作，且极易受到攻击。
  * **冷却与重置：** 当第一名玩家成功激活并撤离后，该撤离点会立即进入长达 `extraction_cooldown_sec`（默认 30-45秒）的**冷却（重置）期**。冷却期间，出口关闭，无法进行新的撤离交互。冷却结束后，出口重新开放，但**剩余撤离名额减一**。

* **信息收缩——全图脉冲压迫：**
  * **死神之眼：** 服务端每隔 `global_pulse_interval_sec`（默认 15）秒，会对全图执行一次扫描，然后将**所有幸存玩家的大致位置**（精确到区域象限级别）广播给**每一个人**。这意味着所有人的行踪都将定期半公开。
  * **视野衰减：** 与此同时，所有幸存玩家的**视野半径**开始随时间流逝而**缓慢衰减**，衰减速度为 `view_radius_decay_rate_per_sec`。视野半径最低会降至 `view_radius_min`（默认 2.0）米，几乎等同于“摸黑”，极大地增加了寻找撤离点和规避敌人的难度。

* **阶段终极目的：** 在**位置定期暴露**和**视野急剧收缩**的双重高压下，幸存者们必须做出抉择：是合作冲向撤离点，还是在门口进行最后的生死搏杀，以争夺那屈指可数的生存名额。

---

### 5. 结算与清理阶段：尘埃落定

**触发条件：** 满足以下任一条件：①所有撤离名额被用完；②全场除一人外全部阵亡；③游戏总时长达到 `gameplay.total_max_time_sec` 上限。

* **最终结算规则：**
  * **撤离成功者（胜利）：** 其携带出场的所有“宝藏”将按比例**100%转换为游戏赏金**。同时，其背包内的**所有道具**（包括安全箱内和外）均得以保留，带回仓库。
  * **撤离失败/失踪者（阵亡或未撤离）：** 仅能保留存放在“**安全箱**”内的 `gameplay.safe_slot_count` 件物品。**背包内其余所有道具、以及已拾取但未带出的“宝藏”，将全部清零**，不予结算赏金。
  * **综合评价与奖励：** 系统将根据玩家本局的**生存时长、击杀数、对电机破译的贡献度、最终携带宝藏的总价值**等多个维度，进行综合评分，并据此发放经验、货币或其他排名奖励。

* **服务端清理工作：**
  1.  **信号发送：** 向所有仍连接的客户端（包括观战者）发送“游戏结束”信号，并附上详细的个人结算数据包。
  2.  **连接释放：** 安全断开该房间实例的所有网络连接。
  3.  **资源回收：** 释放为该房间服务的所有 Goroutine 及内存资源。
  4.  **数据持久化：** 将玩家的本局收益（赏金、经验）、战绩（胜/负/生存率）以及仓库道具的变动，**异步写入**持久化存储系统（如 Redis 作缓存，MySQL 作最终落地）。
  5.  **实例销毁：** 最终，销毁这个房间实例，一切重归于寂静，等待下一批猎手的到来。

---

### 给开发者的关键提示与实施要点：

1.  **心跳同步与实时性：** 整个游戏流程中，服务端必须严格维持 `server.tick_rate_ms`（默认 50ms）的**固定心跳频率**。确保基于负重的速度变化、视野范围的裁剪计算、玩家位置的同步更新以及各类状态（如破译、攻击）的即时判断，都能在此高频Tick下**平滑、实时地**完成。
2.  **配置驱动原则：** 上述所有逻辑判断中使用的数值和条件（如负重阈值、视野距离、各阶段时长、生成物数量、触发条件等），**必须**从 `game_config.json` 配置文件中动态读取。**严禁在业务逻辑代码中硬编码（Hardcode）任何魔法数字**。配置文件本身应结构清晰，包含合理的默认值和必要的参数验证逻辑。
3.  **日志与调试（Alpha阶段）：** 在开发与Alpha测试阶段，建议根据 `debug_log_color` 的配置，为每一个**阶段的转换事件**、以及玩家的**每一个关键行为**（连接、断开、拾取关键道具、击杀、被击杀、开始/完成破译、尝试/成功撤离）打印**带颜色区分的日志**。这将极大便利于演示效果展示、逻辑调试和问题追踪。
4.  **网络流量优化：** 采用 **AOI (Area of Interest，兴趣区域)** 系统来管理玩家状态（位置、动作）的广播。确保大部分通信只发生在一定范围内的玩家之间，大幅减少不必要的网络流量。注意，电机破译的广播和终局阶段的全图脉冲属于**全图特殊事件**，应做例外处理。
5.  **状态同步与反作弊：** 必须确保客户端与服务端在**关键游戏状态**上保持强一致性，包括但不限于：玩家坐标、生命值、背包物品列表、电机破译进度、撤离点状态等。核心逻辑判定务必在**服务端权威**进行，并对客户端输入进行验证，以有效防止各类作弊行为。

--- 文档生成结束 ---

--- End of Generation ---