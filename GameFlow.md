# Echo Trace 当前版本游戏流程（与代码一致）

> 本文档以当前实现为准，数值以 `game_config.json` 为准。道具效果以 `Items.md` 与服务端逻辑为准。

---

## 0. 客户端入口流程

1. **CONNECT**：输入服务器地址并回车连接（默认 `ws://localhost:8080/ws`）
2. **LOGIN**：输入代号并回车登录
3. **MENU**：
     - CREATE：进入房间配置并创建
     - JOIN：加入已有房间（简化实现：加入列表中的房间）
4. **CONFIG**：配置最大人数/电机数/阶段时长（也可通过 payload.config 传入结构化配置覆盖）

---

## 1. 大厅（Phase 0）与战术选择

- 进入房间后处于大厅阶段（Phase 0）
- 玩家用数字键选择战术倾向：
    - `1`：RECON
    - `2`：DEFENSE
    - `3`：TRAP
- 战术会影响：基础属性倍率 + 道具效果倍率 + 房间道具刷新倾向

---

## 2. 核心操作（默认键位）

### 2.1 基本操作

- `WASD`：移动
- 鼠标：决定角色面向（影响 90°扇形视野方向）
- `E`：拾取（附近道具/补给）
- `F`：交互 / 打开商店
- `ESC`：打开暂停菜单

### 2.2 背包与道具

- `1-6`：使用背包对应格子的道具
- `Shift+1-6`：丢弃背包对应格子的道具

> 说明：当前版本不存在“携带即生效”的被动道具；相关效果均改为“使用后持续一段时间”的限时增益。

### 2.3 商店（靠近商人后）

- `F`：靠近商人时打开/关闭商店
- `1-6`：购买商店对应槽位商品（服务端下发 `shop_stock`）
- `Ctrl+1-6`：出售背包对应槽位道具（需要靠近商人）
- `R`：刷新商品
    - 每阶段每玩家第 1 次免费
    - 后续刷新扣除 `items.merchant_refresh_cost`

---

## 3. 视野与信息规则（核心体验）

- 视野为 **90° 扇形**，并跟随鼠标面向
- 墙体会遮挡视线（LOS）
- 客户端 Fog 策略：
    - 扇形外全黑
    - 扇形内地图可见
    - **实体**仅在“扇形内且无遮挡”时可见
- 服务端也会按同样规则做 AOI 过滤，只下发可见实体，避免信息泄露

---

## 4. 阶段流程（Phase 1~3）

### 4.1 Phase 1：Search（搜寻）

- 主要目标：搜刮道具与资金，准备冲突阶段
- 场景事件：会生成补给箱（Supply Drop）与散落道具
- 商人：处于该阶段固定锚点，提供购买/出售/刷新

### 4.2 Phase 2：Conflict（冲突）

- 进入条件：Phase 1 倒计时结束
- 刷新：电机（Motors）与阶段补给
- 胜负推动：修复电机累计达到阈值（当前实现为 2 台）会进入撤离阶段
- 脉冲提示：冲突阶段会周期触发“电机脉冲”事件（用于事件提示与雷达提示电机）

### 4.3 Phase 3：Escape（撤离）

- 进入条件：电机修复达到阈值
- 刷新：出口（Exit）与阶段补给
- 撤离：对出口持续交互 3 秒成功撤离

> 注：配置文件中存在“视野衰减、撤离名额限制”等字段，但当前代码未完整实现；因此本文档不把它们作为既定规则描述。

---

## 5. 结算与观战

- **撤离成功**：
    - 背包道具按价值结算为资金（Funds）
    - 背包清空
    - 玩家进入“已撤离”观战态（可以全图观战）
- **死亡**：死亡会掉落背包道具到地面（当前实现）

---

## 6. 暂停菜单（ESC）

- RESUME：继续
- SETTINGS：设置（语言、鼠标灵敏度等）
- ITEM MANUAL：道具手册（支持鼠标滚轮滚动，`ESC`/BACK 返回）
- HELP：帮助
- QUIT：退出到菜单

